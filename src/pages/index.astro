---
import Layout from '../layouts/Layout.astro';
import styles from './index.module.scss';
---

<Layout>
	<head>
		<title>Dialpad</title>
	</head>
	<section>
		<div id="dialpad" class={styles.dialpad}>
			<h1 id="phonenumber">Dial: </h1>

			<div class={styles.keyrow}>
				<button data-tone="1">
					１
				</button>
				<button data-tone="2">
					２
				</button>
				<button data-tone="3">
					３
				</button>
			</div>
			<div class={styles.keyrow}>
				<button data-tone="4">
					４
				</button>
				<button data-tone="5">
					５
				</button>
				<button data-tone="6">
					６
				</button>
			</div>
			<div class={styles.keyrow}>
				<button data-tone="7">
					７
				</button>
				<button data-tone="8">
					８
				</button>
				<button data-tone="9">
					９
				</button>
			</div>
			<div class={styles.keyrow}>
				<button data-tone="*">
					＊
				</button>
				<button data-tone="0">
					０
				</button>
				<button data-tone="#">
					＃
				</button>
			</div>
			<div class={styles.keyrow}>
				<button id='callButton' class="callButton">
					<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#ededed"><path d="M162-120q-18 0-30-12t-12-30v-162q0-13 9-23.5t23-14.5l138-28q14-2 28.5 2.5T342-374l94 94q38-22 72-48.5t65-57.5q33-32 60.5-66.5T681-524l-97-98q-8-8-11-19t-1-27l26-140q2-13 13-22.5t25-9.5h162q18 0 30 12t12 30q0 125-54.5 247T631-329Q531-229 409-174.5T162-120Zm556-480q17-39 26-79t14-81h-88l-18 94 66 66ZM360-244l-66-66-94 20v88q41-3 81-14t79-28Zm358-356ZM360-244Z"/></svg>
				</button>
			</div>
		</div>
	</section>
</Layout>

<script is:inline>
  // DTMF周波数対応表
  const dtmfFrequencies = {
    '1': [697, 1209],
    '2': [697, 1336],
    '3': [697, 1477],
    '4': [770, 1209],
    '5': [770, 1336],
    '6': [770, 1477],
    '7': [852, 1209],
    '8': [852, 1336],
    '9': [852, 1477],
    '*': [941, 1209],
    '0': [941, 1336],
    '#': [941, 1477],
  };

  // AudioContext作成
  let audioCtx;
  function playDTMF(tone) {
    if (!audioCtx) {
      audioCtx = new AudioContext();
    }

    const [f1, f2] = dtmfFrequencies[tone] || [];
    if (!f1 || !f2) return;

    const duration = 0.2; // 秒

    // オシレーター作成
    const osc1 = audioCtx.createOscillator();
    const osc2 = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    osc1.frequency.value = f1;
    osc2.frequency.value = f2;

    osc1.type = 'sine';
    osc2.type = 'sine';

    // 2つのオシレーターをGainに繋げる
    osc1.connect(gainNode);
    osc2.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    // 音量調整
    gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);

    osc1.start();
    osc2.start();

    osc1.stop(audioCtx.currentTime + duration);
    osc2.stop(audioCtx.currentTime + duration);
  }

	const dialpad = document.getElementById('dialpad');
	if (dialpad) {
  	dialpad.addEventListener('click', (e) => {
    	if (e.target.tagName === 'BUTTON' && e.target.dataset.tone) {
      	playDTMF(e.target.dataset.tone);
    	}
  	});
	}

	const buttons = document.querySelectorAll('[data-tone]');
	const phoneDisplay = document.getElementById('phonenumber');

	if (buttons.length > 0 && phoneDisplay) {
  	buttons.forEach(button => {
    	button.addEventListener('click', () => {
      	const tone = button.dataset.tone;
	      phoneDisplay.textContent += tone;
  	  });
  	});
	}

	const callButton = document.getElementById("callButton");
	if (callButton) {
  	callButton.addEventListener("click", function() {
    	document.getElementById("phonenumber").textContent = "Dial: ";
	  });
	}
</script>

<style>
	section {
	  display: flex;
  	flex-direction: column;
	  width: 100%;
  	height: 100%;
	}

	button {
  	background: linear-gradient(-45deg, var(--footerBarBackground-left), var(--footerBarBackground-right));
	  width: 70px;
  	height: 70px;
	  border-radius: 50%;
  	border: 1px solid var(--foreground);
	  margin: -15px 15px;
  	font-size: 24px;
	}
	button.callButton {
		background-color: rgb(0, 255, 170);
		@media (prefers-color-scheme: dark) {
    	background: rgb(0, 182, 121);
  	}
	}

	h1 {
		font-size: 1.4em;
	}
</style>